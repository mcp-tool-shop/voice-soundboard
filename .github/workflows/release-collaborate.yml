name: Release Claude Collaborate

on:
  push:
    tags:
      - 'collaborate-v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install aiohttp

      - name: Validate Claude Collaborate
        run: |
          echo "Validating Claude Collaborate structure..."
          test -f claude_collaborate/index.html && echo "  index.html"
          test -f claude_collaborate/whiteboard.html && echo "  whiteboard.html"
          test -f claude_collaborate/code-playground.html && echo "  code-playground.html"
          test -f claude_collaborate/chess.html && echo "  chess.html"
          test -f claude_collaborate/capture-viewer.html && echo "  capture-viewer.html"
          test -f claude_collaborate/github-toolkit.html && echo "  github-toolkit.html"
          test -f voice_soundboard/web_server.py && echo "  web_server.py"
          echo "All required files present!"

      - name: Create Release Package
        run: |
          VERSION=${{ github.event.inputs.version || github.ref_name }}
          VERSION=${VERSION#collaborate-v}  # Strip prefix if from tag
          mkdir -p dist

          # Create release archive
          tar -czvf dist/claude-collaborate-${VERSION}.tar.gz \
            claude_collaborate/ \
            claude_adventures/ \
            voice_soundboard/ \
            --exclude='*.pyc' \
            --exclude='__pycache__'

          echo "Created dist/claude-collaborate-${VERSION}.tar.gz"
          ls -la dist/

      - name: Generate Release Notes
        run: |
          VERSION=${{ github.event.inputs.version || github.ref_name }}
          VERSION=${VERSION#collaborate-v}

          cat << 'RELEASE_EOF' > release_notes.md
          # Claude Collaborate v${VERSION}

          > **Where Human Creativity Meets AI Intelligence**

          Claude Collaborate is a unified sandbox environment for real-time human-AI collaboration, bringing together voice synthesis, interactive workspaces, and seamless communication.

          ## Highlights

          - **Unified Server** - Everything runs on port 8080
          - **7 Integrated Environments** - Voice Studio, Creative Lab, Whiteboard, Code Workshop, Chess, Capture Viewer, GitHub Toolkit
          - **Real-time WebSocket Bridge** - Instant communication with Claude Code
          - **Collapsible Communication Panel** - Maximizes your workspace
          - **25+ TTS Voices** - Powered by Kokoro

          ## Quick Start

          ```bash
          # Install dependencies
          pip install aiohttp

          # Start the server
          python -m voice_soundboard.web_server

          # Open Claude Collaborate
          # http://localhost:8080/collaborate
          ```

          ## What's Included

          | Environment | Description |
          |-------------|-------------|
          | Voice Studio | Full TTS controls with preset management |
          | Creative Lab | Interactive experiments and demos |
          | Whiteboard | Drawing and brainstorming canvas |
          | Code Workshop | Live HTML/CSS/JS editor |
          | Chess Workshop | Strategy analysis board |
          | Capture Viewer | Screenshots and recordings |
          | GitHub Toolkit | README and marketing generators |

          ## For Developers

          The WebSocket bridge allows Claude Code integration:

          ```bash
          # Read messages from UI
          curl http://localhost:8080/api/ws/messages

          # Send response to browser
          curl -X POST http://localhost:8080/api/ws/respond \
            -H "Content-Type: application/json" \
            -d '{"content": "Hello from Claude!"}'
          ```

          ---

          *Built with love for human-AI collaboration*
          RELEASE_EOF

          # Replace version placeholder
          sed -i "s/\${VERSION}/${VERSION}/g" release_notes.md
          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: "Claude Collaborate v${{ github.event.inputs.version || github.ref_name }}"
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            dist/claude-collaborate-*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Job Summary
        run: |
          VERSION=${{ github.event.inputs.version || github.ref_name }}
          VERSION=${VERSION#collaborate-v}

          echo "## Claude Collaborate Release Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Package Contents" >> $GITHUB_STEP_SUMMARY
          echo "- Claude Collaborate UI (7 environments)" >> $GITHUB_STEP_SUMMARY
          echo "- Claude Adventures (Creative Lab)" >> $GITHUB_STEP_SUMMARY
          echo "- Unified Web Server" >> $GITHUB_STEP_SUMMARY
          echo "- Voice Soundboard Integration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Start" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'pip install aiohttp' >> $GITHUB_STEP_SUMMARY
          echo 'python -m voice_soundboard.web_server' >> $GITHUB_STEP_SUMMARY
          echo '# http://localhost:8080/collaborate' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
